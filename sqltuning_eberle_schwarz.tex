\documentclass[11pt,a4paper,parskip=half]{scrartcl}
\usepackage{ngerman}
\usepackage[utf8]{inputenc}
\usepackage[colorlinks=false,pdfborder={0 0 0}]{hyperref}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{longtable}
\usepackage{float}
\usepackage{textcomp}
\usepackage{geometry}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{nameref}
\geometry{a4paper, left=30mm, right=25mm, top=30mm, bottom=35mm} 
\usepackage{listings}
\lstset{breaklines=true, breakatwhitespace=true, basicstyle=\scriptsize, numbers=left}
\setcounter{tocdepth}{2} %no subsubsections in TOC

\title{dbarc: Ausarbeitung SQLTuning}
\author{Yanick Eberle, Pascal Schwarz}
\begin{document}
\maketitle
\vfill
\tableofcontents

\section{Einleitung}



\section{Statistiken}
\subsection{Statistiken sammeln}
Mit dem folgenden Befehl werden die Statistiken für alle Tabellen aufgebaut:
\begin{lstlisting}
BEGIN
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','customers');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','lineitems');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','nations');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','orders');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','parts');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','partsupps');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','regions');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','suppliers');
END;
\end{lstlisting}

\subsection{Zeilen, Bytes, Blöcke und Extents der Tabellen}
Um die Anzahl Extents festzustellen, haben wir uns Informationen der Tabelle \emph{DBA\_SEGMENTS} bedient. Eine kurze Google-Recherche führte uns auf die Seite \url{http://www.rocket99.com/techref/oracle8409.html}, die uns bei dieser Aufgabe behilflich war.

\begin{lstlisting}
SELECT stat.table_name, stat.num_rows, stat.blocks, seg.extents,
  stat.avg_row_len*stat.num_rows AS size_bytes
FROM user_tab_statistics stat
JOIN DBA_SEGMENTS seg ON (stat.table_name = seg.segment_name)
WHERE seg.owner = 'DBARC02'

TABLE_NAME                       NUM_ROWS     BLOCKS    EXTENTS SIZE_BYTES
------------------------------ ---------- ---------- ---------- ----------
CUSTOMERS                          150000       3494         43   23850000 
LINEITEMS                         6001215     109217        179  750151875 
NATIONS                                25          4          1       2675 
ORDERS                            1500000      24284         95  166500000 
PARTS                              200000       3859         46   26400000 
PARTSUPPS                          800000      16650         88  114400000 
REGIONS                                 5          4          1        480 
SUPPLIERS                           10000        220         17    1440000 
\end{lstlisting}


\section{Ausführungsplan}
Die Ausführung des EXPLAIN PLAN-Befehles erzeugt folgende Ausgabe:
\begin{lstlisting}
plan FOR succeeded.
\end{lstlisting}

Und die Abfrage des Ausführungsplans zeigt erwartungsgemäss einen kompletten Tabellenzugriff, da das SELECT-Statement ja keine WHERE-Klausel verwendet.
\begin{lstlisting}
PLAN_TABLE_OUTPUT                                                                                                                                                                                                                                                                                          
---------------------------------------------------------------------------
Plan hash value: 3931018009                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------------                                                                                                                                                                                                                                  
| Id  | Operation         | Name  | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                  
---------------------------------------------------------------------------                                                                                                                                                                                                                                  
|   0 | SELECT STATEMENT  |       |   200K|    25M|  1051   (1)| 00:00:13 |                                                                                                                                                                                                                                  
|   1 |  TABLE ACCESS FULL| PARTS |   200K|    25M|  1051   (1)| 00:00:13 |                                                                                                                                                                                                                                  
---------------------------------------------------------------------------     
\end{lstlisting}


\section{Versuche ohne Index}
\subsection{Projektion}
\subsubsection{* FROM}
\label{no-idx-pro-all}
Das erste Statement (SELECT * FROM...) erzeugt einen Output sehr ähnlich dem bereits Gezeigten. Es werden sämtliche 1.5 Millionen Zeilen der Tabelle gelesen. Da es sich dabei primär um I/O handelt, ist der Anteil der CPU an den Kosten mit lediglich einem Prozent entsprechend gering.
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |  1500K|   158M|  6610   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|   1 |  TABLE ACCESS FULL| ORDERS |  1500K|   158M|  6610   (1)| 00:01:20 |                                                                                                                                                                                                                                 
---------------------------------------------------------------------------- 
\end{lstlisting}

\subsubsection{o\_clerk FROM}
\label{no-idx-pro-singlecol}
Bei der Projektion auf eine einzige Spalte der Tabelle Orders fällt ein Grossteil der Daten weg (22M statt 158M), ansonsten sind die Unterschiede aber sehr gering. Vom Festspeicher müssen die selben Blöcke gelesen werden, erst danach können die Inhalte der nicht angefragten Spalten verworfen werden. Daher fallen auch die Kosten nur geringfügig tiefer aus.
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |  1500K|    22M|  6607   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|   1 |  TABLE ACCESS FULL| ORDERS |  1500K|    22M|  6607   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------
\end{lstlisting}

\subsubsection{DISTINCT o\_clerk FROM}
\label{no-idx-pro-singlecol-distinct}
Für das SELECT DISTINCT Statement werden in einem ersten Schritt (Id:2) wiederum alle Daten der entsprechenden Spalte der Tabelle geladen (Kosten wiederum 6607). Danach werden mittels HASH UNIQUE die doppelt vorhandenen Werte ermittelt und entfernt. Dies erzeugt noch ein wenig CPU-Last, aber senkt die Anzahl Zeilen von 1.5 Millionen auf 1000 und verringert dadurch auch den Speicherbedarf von 22M auf 16000 Bytes.
\begin{lstlisting}
-----------------------------------------------------------------------------                                                                                                                                                                                                                                
| Id  | Operation          | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                
-----------------------------------------------------------------------------                                                                                                                                                                                                                                
|   0 | SELECT STATEMENT   |        |  1000 | 16000 |  6676   (2)| 00:01:21 |                                                                                                                                                                                                                                
|   1 |  HASH UNIQUE       |        |  1000 | 16000 |  6676   (2)| 00:01:21 |                                                                                                                                                                                                                                
|   2 |   TABLE ACCESS FULL| ORDERS |  1500K|    22M|  6607   (1)| 00:01:20 |                                                                                                                                                                                                                                
----------------------------------------------------------------------------- 
\end{lstlisting}

\subsection{Selektion}
\subsubsection{Exact Point}
\label{no-idx-sel-exactpoint}
Obwohl das Exact-Point Query lediglich eine einzige Zeile zurückliefert fallen die Kosten mit 6602 beinahe so hoch wie bei der Projektion auf eine einzige Spalte der selben Tabelle (ohne Selektion) aus. Da kein Index für diese Spalte vorhanden ist, kann das Datenbanksystem die Abfrage nicht effizienter als mittels linearer Suche ausführen.
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |     1 |   111 |  6602   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |     1 |   111 |  6602   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"=44444) 
\end{lstlisting}

\subsubsection{Partial Point, OR}
\label{no-idx-sel-partial-or}
Die OR-Verknüpften Bedingungen und die daraus resultierende höhere Anzahl an zurückzugebenden Zeilen erhöhen die Kosten gegenüber dem Exact Point Query noch ein wenig. Weiterhin dürfte aber die Notwendigkeit des Lesens der gesamten Tabelle für die lineare Suche den grössten Teil der Kosten ausmachen.

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |  1501 |   162K|  6629   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |  1501 |   162K|  6629   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_CLERK"='Clerk#000000286' OR "O_ORDERKEY"=44444)    
\end{lstlisting}

\subsubsection{Partial Point, AND}
\label{no-idx-sel-partial-and}
Wiederum muss die gesamte Tabelle geladen werden und die Kosten fallen ähnlich aus. Die gegenüber dem vorherigen Query leicht geringeren Kosten erklären wir uns folgendermassen:
\begin{itemize}
	\item Es müssen je Zeile nur dann beide Bedingungen geprüft werden, wenn die erste Bedingung erfüllt ist.
	\item Nur eine einzige Zeile erfüllt beide Bedingungen.
\end{itemize}

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |     1 |   111 |  6611   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |     1 |   111 |  6611   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"=44444 AND "O_CLERK"='Clerk#000000286')   
\end{lstlisting}

\subsubsection{Partial Point, AND und Funktion}
\label{no-idx-sel-partial-and-function}
Die Multiplikation des Feldes \emph{O\_ORDERKEY} sowie die erhöhte Anzahl an zurückzugebenden Zeilen erhöhen die Kosten gegenüber dem vorherigen Query in geringem Masse.

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |    15 |  1665 |  6615   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |    15 |  1665 |  6615   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"*2=44444 AND "O_CLERK"='Clerk#000000286')  
\end{lstlisting}

\subsubsection{Range Query}
\label{no-idx-sel-range}
Für das Range Query muss aufgrund der nicht vorhandenen Indices die komplette Tabelle geladen werden. Die AND-Verknüpfung erlaubt es wiederum, für viele Zeilen die Überprüfung der zweiten Bedingung zu überspringen.

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        | 27780 |  3011K|  6603   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS | 27780 |  3011K|  6603   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"<=222222 AND "O_ORDERKEY">=111111)  
\end{lstlisting}

Die grösse des Intervalls spielt in diesem Fall praktisch keine Rolle:
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |   249K|    26M|  6605   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |   249K|    26M|  6605   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"<=999222 AND "O_ORDERKEY">=000111)  
\end{lstlisting}

\subsubsection{Partial Range Query}
\label{no-idx-sel-range-partial}
Das Partial Range Query weist gegenüber dem einfachen Range Query praktisch keine Unterschiede auf. Wiederum muss die gesamte Tabelle durchsucht werden und nur für wenige Zeilen brauchen alle vier Bedingungen geprüft zu werden.

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |     6 |   666 |  6611   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |     6 |   666 |  6611   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"<=55555 AND "O_CLERK"<='Clerk#000000139' AND                                                                                                                                                                                                                                       
              "O_ORDERKEY">=44444 AND "O_CLERK">='Clerk#000000130') 
\end{lstlisting}

\subsection{Join}
\label{no-idx-join}
Das Query in der gegebenen Form führt auf dieser Datenbasis ohne Indices dazu, dass beide im Join beteiligten Tabellen zunächst vollständig geladen werden müssen. Die Bedingung auf Orders führt dazu, dass lediglich 25 Zeilen aus dieser Tabelle verwendet werden.

Der HASH JOIN der beiden Relationen (25 Zeilen gejoint mit 150000 Zeilen) führt zu Kosten von 953.

\begin{lstlisting}
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
| Id  | Operation          | Name      | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                             
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
|   0 | SELECT STATEMENT   |           |    25 |  6750 |  7555   (1)| 00:01:31 |                                                                                                                                                                                                                             
|*  1 |  HASH JOIN         |           |    25 |  6750 |  7555   (1)| 00:01:31 |                                                                                                                                                                                                                             
|*  2 |   TABLE ACCESS FULL| ORDERS    |    25 |  2775 |  6602   (1)| 00:01:20 |                                                                                                                                                                                                                             
|   3 |   TABLE ACCESS FULL| CUSTOMERS |   150K|    22M|   951   (1)| 00:00:12 |                                                                                                                                                                                                                             
--------------------------------------------------------------------------------                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
   2 - filter("O_ORDERKEY"<100)  
\end{lstlisting}

Die Formulierung des Joins mittels JOIN ... ON (bedingung) führt zum selben Ausführungsplan.
\begin{lstlisting}
SELECT *
FROM orders
JOIN customers ON (c_custkey = o_custkey)
WHERE o_orderkey < 100;
\end{lstlisting}

Dies gilt auch für die Variante mit CROSS JOIN und der custkey-Bedingung in WHERE.
\begin{lstlisting}
SELECT *
FROM orders
CROSS JOIN customers
WHERE o_orderkey < 100
AND
c_custkey = o_custkey;
\end{lstlisting}

\section{Versuche mit Index}
\subsection{Erzeugung Indices}


\subsection{Projektion}
beispielverweis: \ref{no-idx-join} auf Seite \pageref{no-idx-join} oder auch \ref{no-idx-join} \nameref{no-idx-join} auf Seite \pageref{no-idx-join}

ziele von referenzen sind immer labels (oben jeweils gleich nach subsection etc.)

\subsection{Selektion}


\subsection{Join}


\end{document}