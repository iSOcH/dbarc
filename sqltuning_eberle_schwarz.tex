\documentclass[11pt,a4paper,parskip=half]{scrartcl}
\usepackage{ngerman}
\usepackage[utf8]{inputenc}
\usepackage[colorlinks=false,pdfborder={0 0 0}]{hyperref}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{longtable}
\usepackage{float}
\usepackage{textcomp}
\usepackage{geometry}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{nameref}
\geometry{a4paper, left=30mm, right=25mm, top=30mm, bottom=35mm} 
\usepackage{listings}
\lstset{breaklines=true, breakatwhitespace=true, basicstyle=\tiny, numbers=left}
\setcounter{tocdepth}{2} %no subsubsections in TOC

\title{dbarc: Ausarbeitung SQLTuning}
\author{Yanick Eberle, Pascal Schwarz}
\begin{document}
\maketitle
\vfill
\tableofcontents

\section{Statistiken}
\subsection{Statistiken sammeln}
Mit dem folgenden Befehl werden die Statistiken für alle Tabellen aufgebaut:
\begin{lstlisting}
BEGIN
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','customers');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','lineitems');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','nations');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','orders');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','parts');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','partsupps');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','regions');
  DBMS_STATS.GATHER_TABLE_STATS('dbarc02','suppliers');
END;
\end{lstlisting}

\subsection{Zeilen, Bytes, Blöcke und Extents der Tabellen}
Um die Anzahl Extents festzustellen, haben wir uns Informationen der Tabelle \emph{DBA\_SEGMENTS} bedient. Eine kurze Google-Recherche führte uns auf die Seite \url{http://www.rocket99.com/techref/oracle8409.html}, die uns bei dieser Aufgabe behilflich war.

\begin{lstlisting}
SELECT stat.table_name, stat.num_rows, stat.blocks, seg.extents,
  stat.avg_row_len*stat.num_rows AS size_bytes
FROM user_tab_statistics stat
JOIN DBA_SEGMENTS seg ON (stat.table_name = seg.segment_name)
WHERE seg.owner = 'DBARC02'

TABLE_NAME                       NUM_ROWS     BLOCKS    EXTENTS SIZE_BYTES
------------------------------ ---------- ---------- ---------- ----------
CUSTOMERS                          150000       3494         43   23850000 
LINEITEMS                         6001215     109217        179  750151875 
NATIONS                                25          4          1       2675 
ORDERS                            1500000      24284         95  166500000 
PARTS                              200000       3859         46   26400000 
PARTSUPPS                          800000      16650         88  114400000 
REGIONS                                 5          4          1        480 
SUPPLIERS                           10000        220         17    1440000 
\end{lstlisting}


\section{Ausführungsplan}
Die Ausführung des EXPLAIN PLAN-Befehles erzeugt folgende Ausgabe:
\begin{lstlisting}
plan FOR succeeded.
\end{lstlisting}

Und die Abfrage des Ausführungsplans zeigt erwartungsgemäss einen kompletten Tabellenzugriff, da das SELECT-Statement ja keine WHERE-Klausel verwendet.
\begin{lstlisting}
PLAN_TABLE_OUTPUT                                                                                                                                                                                                                                                                                          
---------------------------------------------------------------------------
Plan hash value: 3931018009                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------------                                                                                                                                                                                                                                  
| Id  | Operation         | Name  | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                  
---------------------------------------------------------------------------                                                                                                                                                                                                                                  
|   0 | SELECT STATEMENT  |       |   200K|    25M|  1051   (1)| 00:00:13 |                                                                                                                                                                                                                                  
|   1 |  TABLE ACCESS FULL| PARTS |   200K|    25M|  1051   (1)| 00:00:13 |                                                                                                                                                                                                                                  
---------------------------------------------------------------------------     
\end{lstlisting}


\section{Versuche ohne Index}
\subsection{Projektion}
\subsubsection{* FROM}
\label{no-idx-pro-all}
Das erste Statement (SELECT * FROM...) erzeugt einen Output sehr ähnlich dem bereits Gezeigten. Es werden sämtliche 1.5 Millionen Zeilen der Tabelle gelesen. Da es sich dabei primär um I/O handelt, ist der Anteil der CPU an den Kosten mit lediglich einem Prozent entsprechend gering.
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |  1500K|   158M|  6610   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|   1 |  TABLE ACCESS FULL| ORDERS |  1500K|   158M|  6610   (1)| 00:01:20 |                                                                                                                                                                                                                                 
---------------------------------------------------------------------------- 
\end{lstlisting}

\subsubsection{o\_clerk FROM}
\label{no-idx-pro-singlecol}
Bei der Projektion auf eine einzige Spalte der Tabelle Orders fällt ein Grossteil der Daten weg (22M statt 158M), ansonsten sind die Unterschiede aber sehr gering. Vom Festspeicher müssen die selben Blöcke gelesen werden, erst danach können die Inhalte der nicht angefragten Spalten verworfen werden. Daher fallen auch die Kosten nur geringfügig tiefer aus.
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |  1500K|    22M|  6607   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|   1 |  TABLE ACCESS FULL| ORDERS |  1500K|    22M|  6607   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------
\end{lstlisting}

\subsubsection{DISTINCT o\_clerk FROM}
\label{no-idx-pro-singlecol-distinct}
Für das SELECT DISTINCT Statement werden in einem ersten Schritt (Id:2) wiederum alle Daten der entsprechenden Spalte der Tabelle geladen (Kosten wiederum 6607). Danach werden mittels HASH UNIQUE die doppelt vorhandenen Werte ermittelt und entfernt. Dies erzeugt noch ein wenig CPU-Last, aber senkt die Anzahl Zeilen von 1.5 Millionen auf 1000 und verringert dadurch auch den Speicherbedarf von 22M auf 16000 Bytes.
\begin{lstlisting}
-----------------------------------------------------------------------------                                                                                                                                                                                                                                
| Id  | Operation          | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                
-----------------------------------------------------------------------------                                                                                                                                                                                                                                
|   0 | SELECT STATEMENT   |        |  1000 | 16000 |  6676   (2)| 00:01:21 |                                                                                                                                                                                                                                
|   1 |  HASH UNIQUE       |        |  1000 | 16000 |  6676   (2)| 00:01:21 |                                                                                                                                                                                                                                
|   2 |   TABLE ACCESS FULL| ORDERS |  1500K|    22M|  6607   (1)| 00:01:20 |                                                                                                                                                                                                                                
----------------------------------------------------------------------------- 
\end{lstlisting}

\subsection{Selektion}
\subsubsection{Exact Point}
\label{no-idx-sel-exactpoint}
Obwohl das Exact-Point Query lediglich eine einzige Zeile zurückliefert fallen die Kosten mit 6602 beinahe so hoch wie bei der Projektion auf eine einzige Spalte der selben Tabelle (ohne Selektion) aus. Da kein Index für diese Spalte vorhanden ist, kann das Datenbanksystem die Abfrage nicht effizienter als mittels linearer Suche ausführen.
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |     1 |   111 |  6602   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |     1 |   111 |  6602   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"=44444) 
\end{lstlisting}

\subsubsection{Partial Point, OR}
\label{no-idx-sel-partial-or}
Die OR-Verknüpften Bedingungen und die daraus resultierende höhere Anzahl an zurückzugebenden Zeilen erhöhen die Kosten gegenüber dem Exact Point Query noch ein wenig. Weiterhin dürfte aber die Notwendigkeit des Lesens der gesamten Tabelle für die lineare Suche den grössten Teil der Kosten ausmachen.

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |  1501 |   162K|  6629   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |  1501 |   162K|  6629   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_CLERK"='Clerk#000000286' OR "O_ORDERKEY"=44444)    
\end{lstlisting}

\subsubsection{Partial Point, AND}
\label{no-idx-sel-partial-and}
Wiederum muss die gesamte Tabelle geladen werden und die Kosten fallen ähnlich aus. Die gegenüber dem vorherigen Query leicht geringeren Kosten erklären wir uns folgendermassen:
\begin{itemize}
	\item Es müssen je Zeile nur dann beide Bedingungen geprüft werden, wenn die erste Bedingung erfüllt ist.
	\item Nur eine einzige Zeile erfüllt beide Bedingungen.
\end{itemize}

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |     1 |   111 |  6611   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |     1 |   111 |  6611   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"=44444 AND "O_CLERK"='Clerk#000000286')   
\end{lstlisting}

\subsubsection{Partial Point, AND und Funktion}
\label{no-idx-sel-partial-and-function}
Die Multiplikation des Feldes \emph{O\_ORDERKEY} sowie die erhöhte Anzahl an zurückzugebenden Zeilen erhöhen die Kosten gegenüber dem vorherigen Query in geringem Masse.

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |    15 |  1665 |  6615   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |    15 |  1665 |  6615   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"*2=44444 AND "O_CLERK"='Clerk#000000286')  
\end{lstlisting}

\subsubsection{Range Query}
\label{no-idx-sel-range}
Für das Range Query muss aufgrund der nicht vorhandenen Indices die komplette Tabelle geladen werden. Die AND-Verknüpfung erlaubt es wiederum, für viele Zeilen die Überprüfung der zweiten Bedingung zu überspringen.

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        | 27780 |  3011K|  6603   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS | 27780 |  3011K|  6603   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"<=222222 AND "O_ORDERKEY">=111111)  
\end{lstlisting}

Die Grösse des Intervalls spielt in diesem Fall praktisch keine Rolle:
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |   249K|    26M|  6605   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |   249K|    26M|  6605   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"<=999222 AND "O_ORDERKEY">=000111)  
\end{lstlisting}

\subsubsection{Partial Range Query}
\label{no-idx-sel-range-partial}
Das Partial Range Query weist gegenüber dem einfachen Range Query praktisch keine Unterschiede auf. Wiederum muss die gesamte Tabelle durchsucht werden und nur für wenige Zeilen brauchen alle vier Bedingungen geprüft zu werden.

\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |     6 |   666 |  6611   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |     6 |   666 |  6611   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"<=55555 AND "O_CLERK"<='Clerk#000000139' AND                                                                                                                                                                                                                                       
              "O_ORDERKEY">=44444 AND "O_CLERK">='Clerk#000000130') 
\end{lstlisting}

\subsection{Join}
\label{no-idx-join}
Das Query in der gegebenen Form führt auf dieser Datenbasis ohne Indices dazu, dass beide im Join beteiligten Tabellen zunächst vollständig geladen werden müssen. Die Bedingung auf Orders führt dazu, dass lediglich 25 Zeilen aus dieser Tabelle verwendet werden.

Der HASH JOIN der beiden Relationen (25 Zeilen gejoint mit 150000 Zeilen) führt zu Kosten von 953.

\begin{lstlisting}
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
| Id  | Operation          | Name      | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                             
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
|   0 | SELECT STATEMENT   |           |    25 |  6750 |  7555   (1)| 00:01:31 |                                                                                                                                                                                                                             
|*  1 |  HASH JOIN         |           |    25 |  6750 |  7555   (1)| 00:01:31 |                                                                                                                                                                                                                             
|*  2 |   TABLE ACCESS FULL| ORDERS    |    25 |  2775 |  6602   (1)| 00:01:20 |                                                                                                                                                                                                                             
|   3 |   TABLE ACCESS FULL| CUSTOMERS |   150K|    22M|   951   (1)| 00:00:12 |                                                                                                                                                                                                                             
--------------------------------------------------------------------------------                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
   2 - filter("O_ORDERKEY"<100)  
\end{lstlisting}

Die Formulierung des Joins mittels JOIN ... ON (bedingung) führt zum selben Ausführungsplan.
\begin{lstlisting}
SELECT *
FROM orders
JOIN customers ON (c_custkey = o_custkey)
WHERE o_orderkey < 100;
\end{lstlisting}

Dies gilt auch für die Variante mit CROSS JOIN und der custkey-Bedingung in WHERE.
\begin{lstlisting}
SELECT *
FROM orders
CROSS JOIN customers
WHERE o_orderkey < 100
AND
c_custkey = o_custkey;
\end{lstlisting}

\section{Versuche mit Index}
\subsection{Erzeugung Indices}
Die Indices werden gemäss den Befehlen aus der Aufgabenstellung erstellt (Zeilen 4 und 5 sind Output):
\begin{lstlisting}
CREATE INDEX o_orderkey_ix ON orders(o_orderkey);
CREATE INDEX o_clerk_ix ON orders(o_clerk);

index O_ORDERKEY_IX created.
index O_CLERK_IX created.
\end{lstlisting}

Die Indices sind 30 resp. 48 MByte gross. Zusammen kommen sie somit beinahe auf die halbe Grösse der Tabelle \emph{ORDERS} (ca. 160 MByte). Die Grösse der Indices haben wir gemäss folgendem Output festgestellt:
\begin{lstlisting}
SELECT SEGMENT_NAME, BYTES
FROM DBA_SEGMENTS seg
WHERE seg.owner = 'DBARC02'
AND seg.segment_type = 'INDEX'

SEGMENT_NAME                             BYTES
--------------------------------------- ----------
O_ORDERKEY_IX                            30408704 
O_CLERK_IX                               48234496 
\end{lstlisting}

\subsection{Projektion}
\subsubsection{DISTINCT o\_clerk FROM}
\label{idx-pro-singlecol-distinct}
Im Gegensatz zum Output ohne Index (siehe Abschnitt \ref{no-idx-pro-singlecol-distinct} auf Seite \pageref{no-idx-pro-singlecol-distinct}) fallen die Kosten bei der Abfrage mit Index merklich geringer aus. Der Schritt \emph{HASH UNIQUE} verursacht Kosten von 69, was gegenüber der Abfrage ohne Index keinen Unterschied darstellt. Allerdings ist der \emph{INDEX FAST FULL SCAN} viel günstiger als \emph{TABLE ACCESS FULL} (Kosten sinken von 6607 auf 1546).

Wir erklären uns dies dadurch, dass die Daten für das Query (lediglich Spalte \emph{O\_CLERK}) in diesem Fall direkt aus dem Index gelesen werden während ohne Index für \emph{O\_CLERK} die gesamte Tabelle von der Disk gelesen werden muss. Da der Index ca. vier mal kleiner ist als die Tabelle fallen auch die Kosten ca. viermal kleiner aus.

\begin{lstlisting}
------------------------------------------------------------------------------------                                                                                                                                                                                                                         
| Id  | Operation             | Name       | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                         
------------------------------------------------------------------------------------                                                                                                                                                                                                                         
|   0 | SELECT STATEMENT      |            |  1000 | 16000 |  1615   (5)| 00:00:20 |                                                                                                                                                                                                                         
|   1 |  HASH UNIQUE          |            |  1000 | 16000 |  1615   (5)| 00:00:20 |                                                                                                                                                                                                                         
|   2 |   INDEX FAST FULL SCAN| O_CLERK_IX |  1500K|    22M|  1546   (1)| 00:00:19 |                                                                                                                                                                                                                         
------------------------------------------------------------------------------------
\end{lstlisting}

\subsubsection{* FROM}
Führen wir dasselbe Query wie in Abschnitt \ref{no-idx-pro-all} auf Seite \pageref{no-idx-pro-all} aus, sehen wir einen gegenüber der Variante ohne Index unveränderten Ausführungsplan.

\subsection{Selektion}
\subsubsection{Exact Point}
Das Exact Point Query profitiert in enormem Ausmass vom Index auf \emph{O\_ORDERKEY} (Kosten sinken von 6602 auf 4, vgl. Abschnitt \ref{no-idx-sel-exactpoint} auf Seite \pageref{no-idx-sel-exactpoint}). Zunächst wird im Index der Eintrag mit dem entsprechenden Wert von \emph{O\_ORDERKEY} gesucht und dann die im Index enthaltene ROWID für den Zugriff auf die Tabelle benutzt (\emph{TABLE ACCESS BY INDEX ROWID}). Der Zugriff auf die Tabelle ist notwendig, da wir die ganze Zeile und nicht nur das Feld mit dem Index ausgeben möchten.
\begin{lstlisting}
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
| Id  | Operation                   | Name          | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
|   0 | SELECT STATEMENT            |               |     1 |   111 |     4   (0)| 00:00:01 |                                                                                                                                                                                                                
|   1 |  TABLE ACCESS BY INDEX ROWID| ORDERS        |     1 |   111 |     4   (0)| 00:00:01 |                                                                                                                                                                                                                
|*  2 |   INDEX RANGE SCAN          | O_ORDERKEY_IX |     1 |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   2 - access("O_ORDERKEY"=44444)    
\end{lstlisting}

Verwenden wir den Hint \emph{FULL(orders)} im Statement, erhalten wir den selben Ausführungsplan wie in Abschnitt \ref{no-idx-sel-exactpoint} auf Seite \pageref{no-idx-sel-exactpoint}. Dann wird der Zugriff auf die gesuchte Zeile nicht über den Index vorgenommen.

\subsubsection{Partial Point, OR}
\label{idx-sel-partial-or}
Das Partial Point Query mit der OR Bedingung profitiert vom Index auf \emph{O\_ORDERKEY} und auf \emph{O\_CLERK} (Kosten sinken von 6629 auf 336, vgl. Abschnitt \ref{no-idx-sel-partial-or} auf Seite \pageref{no-idx-sel-partial-or}). Für beide Bedingungen wird im Index der Eintrag mit dem entsprechenden Wert gesucht. Die gefundenen Einträge werden nun mit dem Operator OR verknüpft. Anschliessend wird mit der ermittelten ROWID ein Zugriff auf die Tabelle durchgeführt mit (\emph{TABLE ACCESS BY INDEX ROWID}), da die komplette Zeile und nicht nur der Index ausgegeben werden soll.

Informationen zu den \emph{BITMAP CONVERSION}s und \emph{BITMAP OR} haben wir unter \url{http://gerardnico.com/wiki/database/oracle/bitmap} gefunden. Ein Bitmap-Index (der in diesem Query temporär erzeugt wird) bietet sich an, falls die Spalte eine geringe Anzahl unterschiedlicher Werte aufweist oder wir uns nur für wenige Werte interessieren. Letzteres ist nach den Zugriffen auf die einzelnen Indices (Ids 5 und 7 im Ausführungsplan) der Fall.

Für jede Zeile der Tabelle wird dabei in einem Bit gespeichert, ob der Wert in der gefragten Spalte (\emph{o\_orderkey} oder \emph{o\_clerk}) dem jeweiligen Kriterium entspricht. Diese beiden Bitsequenzen können danach  OR-verknüpft werden und man erhält eine Bitsequenz, die genau für jene RowIDs ein \emph{true} enthält, die danach im Resultat erscheinen sollen.

\begin{lstlisting}
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
| Id  | Operation                        | Name          | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                           
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
|   0 | SELECT STATEMENT                 |               |  1501 |   162K|   336   (0)| 00:00:05 |                                                                                                                                                                                                           
|   1 |  TABLE ACCESS BY INDEX ROWID     | ORDERS        |  1501 |   162K|   336   (0)| 00:00:05 |                                                                                                                                                                                                           
|   2 |   BITMAP CONVERSION TO ROWIDS    |               |       |       |            |          |                                                                                                                                                                                                           
|   3 |    BITMAP OR                     |               |       |       |            |          |                                                                                                                                                                                                           
|   4 |     BITMAP CONVERSION FROM ROWIDS|               |       |       |            |          |                                                                                                                                                                                                           
|*  5 |      INDEX RANGE SCAN            | O_CLERK_IX    |       |       |     8   (0)| 00:00:01 |                                                                                                                                                                                                           
|   6 |     BITMAP CONVERSION FROM ROWIDS|               |       |       |            |          |                                                                                                                                                                                                           
|*  7 |      INDEX RANGE SCAN            | O_ORDERKEY_IX |       |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                           
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   5 - access("O_CLERK"='Clerk#000000286')                                                                                                                                                                                                                                                                   
   7 - access("O_ORDERKEY"=44444)   
\end{lstlisting}

\subsubsection{Partial Point, AND}
Auch das Partial Point Query mit der AND Bedingung profitiert enorm vom  Index auf \emph{O\_ORDERKEY} (Kosten sinken von 6611 auf 4, vgl. Abschnitt \ref{no-idx-sel-partial-and} auf Seite \pageref{no-idx-sel-partial-and}). Im Gegensatz zum Query mit OR muss hier die zweite Bedingung nur dann überprüft werden, wenn die erste Bedingung zugrifft. Daher kann direkt nach dem ersten \emph{INDEX RANGE SCAN} der Zugriff auf die Tabelle gemacht werden. Anschliessend muss nur noch gefiltert werden (der Index \emph{O\_CLERK} wird hier nicht verwendet). Nur eine Zeile erfüllt die erste Bedingung, wodurch die Kosten so niedrig ausfallen.
\begin{lstlisting}
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
| Id  | Operation                   | Name          | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
|   0 | SELECT STATEMENT            |               |     1 |   111 |     4   (0)| 00:00:01 |                                                                                                                                                                                                                
|*  1 |  TABLE ACCESS BY INDEX ROWID| ORDERS        |     1 |   111 |     4   (0)| 00:00:01 |                                                                                                                                                                                                                
|*  2 |   INDEX RANGE SCAN          | O_ORDERKEY_IX |     1 |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_CLERK"='Clerk#000000286')                                                                                                                                                                                                                                                                   
   2 - access("O_ORDERKEY"=44444) 
\end{lstlisting}

\subsubsection{Partial Point, AND mit Funktion}
Auch das Partial Point Query mit der AND Bedingung und der Funktion profitiert vom  Index auf \emph{O\_CLERK} (Kosten sinken von 6615 auf 1464, vgl. Abschnitt \ref{no-idx-sel-partial-and-function} auf Seite \pageref{no-idx-sel-partial-and-function}). Im Gegesatz zum Query mit AND wird hier der Zugriff auf den Index \emph{O\_CLERK} gemacht und anschliessend gefiltert. Da 1500 Zeilen die Bedingung O\_CLERK='Clerk\#000000286' erfüllen sind die Kosten wesentlich höher als beim Partial Point mit AND.
\begin{lstlisting}
------------------------------------------------------------------------------------------                                                                                                                                                                                                                   
| Id  | Operation                   | Name       | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                   
------------------------------------------------------------------------------------------                                                                                                                                                                                                                   
|   0 | SELECT STATEMENT            |            |    15 |  1665 |  1464   (1)| 00:00:18 |                                                                                                                                                                                                                   
|*  1 |  TABLE ACCESS BY INDEX ROWID| ORDERS     |    15 |  1665 |  1464   (1)| 00:00:18 |                                                                                                                                                                                                                   
|*  2 |   INDEX RANGE SCAN          | O_CLERK_IX |  1500 |       |     8   (0)| 00:00:01 |                                                                                                                                                                                                                   
------------------------------------------------------------------------------------------                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"*2=44444)                                                                                                                                                                                                                                                                          
   2 - access("O_CLERK"='Clerk#000000286') 
\end{lstlisting}

\subsubsection{Range Query}
\label{idx-sel-range}
Das Range Query profitiert vom  Index auf \emph{O\_ORDERKEY} (Kosten sinken von 6603 auf 932, vgl. Abschnitt \ref{no-idx-sel-range} auf Seite \pageref{no-idx-sel-range}). Auch hier wird ein \emph{INDEX RANGE SCAN} durchgeführt und anschliessend für alle Treffer ein \emph{TABLE ACCESS BY INDEX ROWID} gemacht.
\begin{lstlisting}
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
| Id  | Operation                   | Name          | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
|   0 | SELECT STATEMENT            |               | 27780 |  3011K|   932   (1)| 00:00:12 |                                                                                                                                                                                                                
|   1 |  TABLE ACCESS BY INDEX ROWID| ORDERS        | 27780 |  3011K|   932   (1)| 00:00:12 |                                                                                                                                                                                                                
|*  2 |   INDEX RANGE SCAN          | O_ORDERKEY_IX | 27780 |       |    68   (0)| 00:00:01 |                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   2 - access("O_ORDERKEY">=111111 AND "O_ORDERKEY"<=222222)                                                                                                                                                                                                                                                 
\end{lstlisting}

Die Intervallgrösse spielt hier eine Rolle, da mit dem Index nur bei den zutreffenden Zeilen ein Zugriff auf die Tabelle durchgeführt wird. Wenn das Intervall vergrössert wird und dadurch mehr Zeilen gefunden werden, werden automatisch mehr Zugriffe auf die Tabelle gemacht, was die Kosten erhöht.\\
Wenn die Range genügend gross ist, wird der Index nicht mehr verwendet, sondern es wird direkt ein \emph{TABLE ACCESS FULL} gemacht, da mit dem INDEX kein besseres Ergebnis erzielt werden kann, wenn jede Zeile im Index ein treffer ist.
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |   249K|    26M|  6605   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |   249K|    26M|  6605   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERKEY"<=999222 AND "O_ORDERKEY">=000111)                                                                                                                                                                                                                                                 
\end{lstlisting}

\subsubsection{Partial Range Query}
Das Partial Range Query kann wiederum vom Index auf \emph{O\_ORDERKEY} und auf \emph{O\_CLERK} profitieren (Kosten sinken von 6611 auf 27, vgl. Abschnitt \ref{no-idx-sel-range-partial} auf Seite \pageref{no-idx-sel-range-partial}). Zuerst wird für jede Bedingung ein \emph{INDEX RANGE SCAN} durchgeführt, welche anschliessend mit der Bedingung AND verknüpft werden. Erst dann wird ein \emph{TABLE ACCESS BY INDEX ROWID} durchgeführt.

Informationen bzgl. \emph{BITMAP} haben wir bereits in Abschnitt \ref{idx-sel-partial-or} auf Seite \pageref{idx-sel-partial-or} angeführt.
\begin{lstlisting}
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
| Id  | Operation                        | Name          | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                           
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
|   0 | SELECT STATEMENT                 |               |     6 |   666 |    27  (12)| 00:00:01 |                                                                                                                                                                                                           
|   1 |  TABLE ACCESS BY INDEX ROWID     | ORDERS        |     6 |   666 |    27  (12)| 00:00:01 |                                                                                                                                                                                                           
|   2 |   BITMAP CONVERSION TO ROWIDS    |               |       |       |            |          |                                                                                                                                                                                                           
|   3 |    BITMAP AND                    |               |       |       |            |          |                                                                                                                                                                                                           
|   4 |     BITMAP CONVERSION FROM ROWIDS|               |       |       |            |          |                                                                                                                                                                                                           
|   5 |      SORT ORDER BY               |               |       |       |            |          |                                                                                                                                                                                                           
|*  6 |       INDEX RANGE SCAN           | O_ORDERKEY_IX |  2780 |       |     9   (0)| 00:00:01 |                                                                                                                                                                                                           
|   7 |     BITMAP CONVERSION FROM ROWIDS|               |       |       |            |          |                                                                                                                                                                                                           
|   8 |      SORT ORDER BY               |               |       |       |            |          |                                                                                                                                                                                                           
|*  9 |       INDEX RANGE SCAN           | O_CLERK_IX    |  2780 |       |    14   (0)| 00:00:01 |                                                                                                                                                                                                           
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   6 - access("O_ORDERKEY">=44444 AND "O_ORDERKEY"<=55555)                                                                                                                                                                                                                                                   
   9 - access("O_CLERK">='Clerk#000000130' AND "O_CLERK"<='Clerk#000000139')                                                                                                                                                                                                                                 
\end{lstlisting}


\subsection{Join}
\subsubsection{Join}
Das gegebene Query mit dem normalen Join führt zu Kosten von 17514. Trotz Index wird ein \emph{TABLE ACCESS FULL} gemacht. Dies aus dem Grund, dass keine Bedingung gesetzt ist und somit für jede Zeile ein Join gemacht wird. Die Kosten des \emph{HASH JOIN}  belaufen sich auf 9953.
\begin{lstlisting}
----------------------------------------------------------------------------------------                                                                                                                                                                                                                     
| Id  | Operation          | Name      | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                                                                                                                                     
----------------------------------------------------------------------------------------                                                                                                                                                                                                                     
|   0 | SELECT STATEMENT   |           |  1500K|   386M|       | 17514   (1)| 00:03:31 |                                                                                                                                                                                                                     
|*  1 |  HASH JOIN         |           |  1500K|   386M|    24M| 17514   (1)| 00:03:31 |                                                                                                                                                                                                                     
|   2 |   TABLE ACCESS FULL| CUSTOMERS |   150K|    22M|       |   951   (1)| 00:00:12 |                                                                                                                                                                                                                     
|   3 |   TABLE ACCESS FULL| ORDERS    |  1500K|   158M|       |  6610   (1)| 00:01:20 |                                                                                                                                                                                                                     
----------------------------------------------------------------------------------------                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

Mit einem Hint kann für das gleiche Query erzwungen werden, dass ein \emph{NESTED LOOP} verwendet werden soll. Das Query sieht nun wie folgt aus:
\begin{lstlisting}
SELECT /*+ USE_NL(customers orders) */* 
FROM orders, customers
WHERE o_custkey = c_custkey;
\end{lstlisting}

Die Kosten für das Query mit dem \emph{NESTED LOOP} sind wesentlich höher als mit dem \emph{HASH JOIN}. Die kompletten Kosten belaufen sich auf 991000000, wobei die beiden \emph{TABLE ACCESS FULL} beinahe gleich sind wie im normalen Join mit \emph{HASH JOIN}. Der \emph{NESTED LOOP} sollte hier auf keinen Fall verwendet werden.
\begin{lstlisting}
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
| Id  | Operation          | Name      | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                             
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
|   0 | SELECT STATEMENT   |           |  1500K|   386M|   991M  (1)|999:59:59 |                                                                                                                                                                                                                             
|   1 |  NESTED LOOPS      |           |  1500K|   386M|   991M  (1)|999:59:59 |                                                                                                                                                                                                                             
|   2 |   TABLE ACCESS FULL| CUSTOMERS |   150K|    22M|   951   (1)| 00:00:12 |                                                                                                                                                                                                                             
|*  3 |   TABLE ACCESS FULL| ORDERS    |    10 |  1110 |  6608   (1)| 00:01:20 |                                                                                                                                                                                                                             
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   3 - filter("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

Ebenfalls mit einem Hint erzwingen wir den \emph{MERGE JOIN}. Das Query sieht wie folgt aus:
\begin{lstlisting}
SELECT /*+ USE_MERGE(customers orders) */* 
FROM orders, customers
WHERE o_custkey = c_custkey;
\end{lstlisting}

Die Kosten für das Query mit dem \emph{MERGE JOIN} sind klar tiefer als beim \emph{NESTED LOOP} aber immer noch ca. 3 mal grösser als beim \emph{HASH JOIN}. Sie belaufen sich auf 50568. Auch hier wird ein \emph{TABLE ACCESS FULL} gemacht, auf welchen jeweils ein \emph{SORT JOIN} ausgeführt wird. Der \emph{MERGE JOIN} wird anschliessend auf die beiden \emph{SORT JOIN} gemacht.
\begin{lstlisting}
-----------------------------------------------------------------------------------------                                                                                                                                                                                                                    
| Id  | Operation           | Name      | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                                                                                                                                    
-----------------------------------------------------------------------------------------                                                                                                                                                                                                                    
|   0 | SELECT STATEMENT    |           |  1500K|   386M|       | 50568   (1)| 00:10:07 |                                                                                                                                                                                                                    
|   1 |  MERGE JOIN         |           |  1500K|   386M|       | 50568   (1)| 00:10:07 |                                                                                                                                                                                                                    
|   2 |   SORT JOIN         |           |   150K|    22M|    52M|  6202   (1)| 00:01:15 |                                                                                                                                                                                                                    
|   3 |    TABLE ACCESS FULL| CUSTOMERS |   150K|    22M|       |   951   (1)| 00:00:12 |                                                                                                                                                                                                                    
|*  4 |   SORT JOIN         |           |  1500K|   158M|   390M| 44366   (1)| 00:08:53 |                                                                                                                                                                                                                    
|   5 |    TABLE ACCESS FULL| ORDERS    |  1500K|   158M|       |  6610   (1)| 00:01:20 |                                                                                                                                                                                                                    
-----------------------------------------------------------------------------------------                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   4 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
       filter("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

Fazit: Das Query mit dem \emph{HASH JOIN} erreicht die geringsten Kosten.

\subsubsection{Join, AND}
Das Query Join mit AND Bedingung kann den Index \emph{O\_ORDERKEY} verwenden und kann daher die Kosten auf 957 reduzieren. Die Anzahl Zeilen bei der Tabelle ORDERS wird von 1500000 auf 25 reduziert, dies dank der AND Bedingung. Bei der Tabelle CUSTOMERS wird immer noch ein \emph{TABLE ACCESS FULL} gemacht. Die Kosten des \emph{HASH JOIN} belaufen sich auf 2.
\begin{lstlisting}
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
| Id  | Operation                    | Name          | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                               
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
|   0 | SELECT STATEMENT             |               |    25 |  6750 |   957   (1)| 00:00:12 |                                                                                                                                                                                                               
|*  1 |  HASH JOIN                   |               |    25 |  6750 |   957   (1)| 00:00:12 |                                                                                                                                                                                                               
|   2 |   TABLE ACCESS BY INDEX ROWID| ORDERS        |    25 |  2775 |     4   (0)| 00:00:01 |                                                                                                                                                                                                               
|*  3 |    INDEX RANGE SCAN          | O_ORDERKEY_IX |    25 |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                               
|   4 |   TABLE ACCESS FULL          | CUSTOMERS     |   150K|    22M|   951   (1)| 00:00:12 |                                                                                                                                                                                                               
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
   3 - access("O_ORDERKEY"<100)                                                                                                                                                                                                                                                                              
\end{lstlisting}

Mit einem Hint kann für das gleiche Query erzwungen werden, dass ein \emph{NESTED LOOP} verwendet werden soll. Das Query sieht nun wie folgt aus:
\begin{lstlisting}
SELECT /*+ USE_NL(customers orders) */*
FROM orders, customers
WHERE o_custkey = c_custkey
AND o_orderkey < 100;
\end{lstlisting}

Auch hier kann der Index \emph{O\_ORDERKEY} verwendet werden. Im Vergleich mit dem ersten Query ohne Bedingung sind die Kosten wesentlich kleiner (von 991000000 auf 23747). Verglichen mit dem \emph{HASH JOIN} mit Bedingung sind die Kosten aber immer noch viel zu hoch und sollte daher nicht verwendet werden.
\begin{lstlisting}
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
| Id  | Operation                    | Name          | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                               
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
|   0 | SELECT STATEMENT             |               |    25 |  6750 | 23747   (1)| 00:04:45 |                                                                                                                                                                                                               
|   1 |  NESTED LOOPS                |               |    25 |  6750 | 23747   (1)| 00:04:45 |                                                                                                                                                                                                               
|   2 |   TABLE ACCESS BY INDEX ROWID| ORDERS        |    25 |  2775 |     4   (0)| 00:00:01 |                                                                                                                                                                                                               
|*  3 |    INDEX RANGE SCAN          | O_ORDERKEY_IX |    25 |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                               
|*  4 |   TABLE ACCESS FULL          | CUSTOMERS     |     1 |   159 |   950   (1)| 00:00:12 |                                                                                                                                                                                                               
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   3 - access("O_ORDERKEY"<100)                                                                                                                                                                                                                                                                              
   4 - filter("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

Ebenfalls mit einem Hint erzwingen wir den \emph{MERGE JOIN}. Das Query sieht wie folgt aus:
\begin{lstlisting}
SELECT /*+ USE_MERGE(customers orders) */*
FROM orders, customers
WHERE o_custkey = c_custkey
AND o_orderkey < 100;
\end{lstlisting}

Der Merge Join kann ebenfalls vom Index \emph{O\_ORDERKEY} profitieren und bringt seine Kosten von 50568 ohne Bedingung auf 6207 mit AND Bedingung. Vergliche mit dem \emph{NESTED LOOP} sind die Kosten beinahe um den Faktor 4 kleiner. Andererseits sind die Kosten gegenüber dem \emph{HASH JOIN} um den Faktor 6 höher.
\begin{lstlisting}
-------------------------------------------------------------------------------------------------------                                                                                                                                                                                                      
| Id  | Operation                     | Name          | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                                                                                                                      
-------------------------------------------------------------------------------------------------------                                                                                                                                                                                                      
|   0 | SELECT STATEMENT              |               |    25 |  6750 |       |  6207   (1)| 00:01:15 |                                                                                                                                                                                                      
|   1 |  MERGE JOIN                   |               |    25 |  6750 |       |  6207   (1)| 00:01:15 |                                                                                                                                                                                                      
|   2 |   SORT JOIN                   |               |    25 |  2775 |       |     5  (20)| 00:00:01 |                                                                                                                                                                                                      
|   3 |    TABLE ACCESS BY INDEX ROWID| ORDERS        |    25 |  2775 |       |     4   (0)| 00:00:01 |                                                                                                                                                                                                      
|*  4 |     INDEX RANGE SCAN          | O_ORDERKEY_IX |    25 |       |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                      
|*  5 |   SORT JOIN                   |               |   150K|    22M|    52M|  6202   (1)| 00:01:15 |                                                                                                                                                                                                      
|   6 |    TABLE ACCESS FULL          | CUSTOMERS     |   150K|    22M|       |   951   (1)| 00:00:12 |                                                                                                                                                                                                      
-------------------------------------------------------------------------------------------------------                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   4 - access("O_ORDERKEY"<100)                                                                                                                                                                                                                                                                              
   5 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
       filter("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

Fazit: Das Query mit dem \emph{HASH JOIN} erreicht die geringsten Kosten.

\subsubsection{Join, INDEX}
Als erstes haben wir den neuen Index erstellt. (Ab Zeile 3 Output)
\begin{lstlisting}
CREATE INDEX c_custkey_ix ON customers(c_custkey);

index C_CUSTKEY_IX erstellt.
\end{lstlisting}

Das Query ergibt genau denselben Ausführungsplan wie mit nur einem Index. Obwohl für beide Tabellen Indices existieren, wird jeweils ein \emph{TABLE ACCESS FULL} durchgeführt.
\begin{lstlisting}
----------------------------------------------------------------------------------------                                                                                                                                                                                                                     
| Id  | Operation          | Name      | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                                                                                                                                     
----------------------------------------------------------------------------------------                                                                                                                                                                                                                     
|   0 | SELECT STATEMENT   |           |  1500K|   386M|       | 17514   (1)| 00:03:31 |                                                                                                                                                                                                                     
|*  1 |  HASH JOIN         |           |  1500K|   386M|    24M| 17514   (1)| 00:03:31 |                                                                                                                                                                                                                     
|   2 |   TABLE ACCESS FULL| CUSTOMERS |   150K|    22M|       |   951   (1)| 00:00:12 |                                                                                                                                                                                                                     
|   3 |   TABLE ACCESS FULL| ORDERS    |  1500K|   158M|       |  6610   (1)| 00:01:20 |                                                                                                                                                                                                                     
----------------------------------------------------------------------------------------                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

Mit einem Hint kann für das gleiche Query erzwungen werden, dass ein \emph{NESTED LOOP} verwendet werden soll. Das Query sieht nun wie folgt aus:
\begin{lstlisting}
SELECT /*+ USE_NL(customers orders) */*
FROM orders, customers
WHERE o_custkey = c_custkey;
\end{lstlisting}

Das Query mit dem \emph{NESTED LOOP} kann vom zweiten Index profitieren. Er für einen \emph{TABLE ACCESS FULL} auf die Tabelle ORDERS durch und greift anschliessend über den Index \emph{C\_CUSTKEY} auf die Tabelle CUSTOMERS zu. Die Kosten für den \emph{NESTED LOOP} liegen ca. bei 3000390.
\begin{lstlisting}
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
| Id  | Operation                    | Name         | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
|   0 | SELECT STATEMENT             |              |  1500K|   386M|  3007K  (1)| 10:01:34 |                                                                                                                                                                                                                
|   1 |  NESTED LOOPS                |              |       |       |            |          |                                                                                                                                                                                                                
|   2 |   NESTED LOOPS               |              |  1500K|   386M|  3007K  (1)| 10:01:34 |                                                                                                                                                                                                                
|   3 |    TABLE ACCESS FULL         | ORDERS       |  1500K|   158M|  6610   (1)| 00:01:20 |                                                                                                                                                                                                                
|*  4 |    INDEX RANGE SCAN          | C_CUSTKEY_IX |     1 |       |     1   (0)| 00:00:01 |                                                                                                                                                                                                                
|   5 |   TABLE ACCESS BY INDEX ROWID| CUSTOMERS    |     1 |   159 |     2   (0)| 00:00:01 |                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   4 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

Ebenfalls mit einem Hint erzwingen wir den \emph{MERGE JOIN}. Das Query sieht wie folgt aus:
\begin{lstlisting}
SELECT /*+ USE_MERGE(customers orders) */*
FROM orders, customers
WHERE o_custkey = c_custkey;
\end{lstlisting}

Auch diese Query ergibt genau denselben Ausführungsplan wie mit nur einem Index. Obwohl für beide Tabellen Indices existieren, wird jeweils ein \emph{TABLE ACCESS FULL} durchgeführt.
\begin{lstlisting}
-----------------------------------------------------------------------------------------                                                                                                                                                                                                                    
| Id  | Operation           | Name      | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                                                                                                                                    
-----------------------------------------------------------------------------------------                                                                                                                                                                                                                    
|   0 | SELECT STATEMENT    |           |  1500K|   386M|       | 50568   (1)| 00:10:07 |                                                                                                                                                                                                                    
|   1 |  MERGE JOIN         |           |  1500K|   386M|       | 50568   (1)| 00:10:07 |                                                                                                                                                                                                                    
|   2 |   SORT JOIN         |           |   150K|    22M|    52M|  6202   (1)| 00:01:15 |                                                                                                                                                                                                                    
|   3 |    TABLE ACCESS FULL| CUSTOMERS |   150K|    22M|       |   951   (1)| 00:00:12 |                                                                                                                                                                                                                    
|*  4 |   SORT JOIN         |           |  1500K|   158M|   390M| 44366   (1)| 00:08:53 |                                                                                                                                                                                                                    
|   5 |    TABLE ACCESS FULL| ORDERS    |  1500K|   158M|       |  6610   (1)| 00:01:20 |                                                                                                                                                                                                                    
-----------------------------------------------------------------------------------------                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   4 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
       filter("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

\section{Quiz}
Ohne Optimierung werden von jeder Tabelle sämtliche Zeilen gelesen. Dies hat enorme Kosten zur Folge.

Die Operation TABLE ACCESS FULL kostet auf der Tabelle LINEITEMS 29675, auf der Tabelle PARTS 1052 und auf der Tabelle PARTSUPPS 4525.

Der erste HASH JOIN auf PARTSUPPS und PARTS kostet 295. Der zweite HASH JOIN auf LINEITEMS und den ersten HASH JOIN kostet 30. Der HASH JOIN ist sehr CPU intensiv.

Ebenfalls ist erkennbar, dass die Abfrage durch die grosse Datenmenge relativ lange dauert. Da es sich um ein COUNT handelt, wird die Anzahl Zeilen am Ende auf 1 reduziert.
\begin{lstlisting}
----------------------------------------------------------------------------------                                                                                                                                                                                                                           
| Id  | Operation            | Name      | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                           
----------------------------------------------------------------------------------                                                                                                                                                                                                                           
|   0 | SELECT STATEMENT     |           |     1 |    45 | 35577   (2)| 00:07:07 |                                                                                                                                                                                                                           
|   1 |  SORT AGGREGATE      |           |     1 |    45 |            |          |                                                                                                                                                                                                                           
|*  2 |   HASH JOIN          |           |     4 |   180 | 35577   (2)| 00:07:07 |                                                                                                                                                                                                                           
|*  3 |    HASH JOIN         |           |     4 |   144 |  5872   (6)| 00:01:11 |                                                                                                                                                                                                                           
|*  4 |     TABLE ACCESS FULL| PARTSUPPS |     4 |    36 |  4525   (1)| 00:00:55 |                                                                                                                                                                                                                           
|*  5 |     TABLE ACCESS FULL| PARTS     |  2667 | 72009 |  1052   (1)| 00:00:13 |                                                                                                                                                                                                                           
|   6 |    TABLE ACCESS FULL | LINEITEMS |  6001K|    51M| 29675   (1)| 00:05:57 |                                                                                                                                                                                                                           
----------------------------------------------------------------------------------                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   2 - access("PS_PARTKEY"="L_PARTKEY" AND "PS_SUPPKEY"="L_SUPPKEY")                                                                                                                                                                                                                                         
   3 - access("P_PARTKEY"="PS_PARTKEY")                                                                                                                                                                                                                                                                      
       filter("PS_PARTKEY"=5 AND "P_TYPE"='MEDIUM ANODIZED BRASS' OR                                                                                                                                                                                                                                         
              "PS_PARTKEY"=5 AND "P_TYPE"='MEDIUM BRUSHED COPPER')                                                                                                                                                                                                                                           
   4 - filter("PS_PARTKEY"=5)                                                                                                                                                                                                                                                                                
   5 - filter("P_TYPE"='MEDIUM ANODIZED BRASS' OR "P_TYPE"='MEDIUM                                                                                                                                                                                                                                           
              BRUSHED COPPER')                                                                                                                                                                                                                                                                               
\end{lstlisting}

Um die Abfrage zu optimieren, haben wir folgende Indices erstellt (ab Zeile 6 Output):
\begin{lstlisting}
CREATE INDEX p_partkey_ix ON parts (p_partkey) ;
CREATE INDEX ps_partkey_ix ON partsupps (ps_partkey) ;
CREATE INDEX l_partkey_ix ON lineitems (l_partkey) ;
CREATE INDEX l_suppkey_ix ON lineitems (l_suppkey) ;

index P_PARTKEY_IX erstellt.
index PS_PARTKEY_IX erstellt.
index L_PARTKEY_IX erstellt.
index L_SUPPKEY_IX erstellt.
\end{lstlisting}

Wir haben versucht weitere Indices zu erstellen, welche jedoch keine weitere Auswirkungen auf die Kosten hatten, weshalb wir sie weggelassen haben:
\begin{lstlisting}
CREATE INDEX ps_suppkey_ix ON partsupps (ps_suppkey) ;
CREATE INDEX p_type_ix ON parts (p_type) ;
\end{lstlisting}

Nach dem Erstellen der Indices sind die Kosten enorm gesunken, von vorher 35577 auf neu 52.

Durch die erstellten Indices werden keine TABLE ACCESS FULL Operationen mehr ausgeführt, sondern INDEX RANGE SCAN Operationen, welche nur minime Kosten verursachen.

Anstelle des HASH JOIN werden neu NESTED LOOPS verwendet.

Weiter haben wir mithilfe verschiedener Hints versucht die Kosten zu senken (\emph{LEADING(...)}, \emph{USE\_HASH(...)}, \emph{USE\_MERGE(...)}, ...) jedoch verwendet Oracle hier automatisch den NESTED LOOP welcher in diesem Fall sehr effizient ist. 
\begin{lstlisting}
---------------------------------------------------------------------------------------------------                                                                                                                                                                                                          
| Id  | Operation                         | Name          | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                          
---------------------------------------------------------------------------------------------------                                                                                                                                                                                                          
|   0 | SELECT STATEMENT                  |               |     1 |    45 |    52   (0)| 00:00:01 |                                                                                                                                                                                                          
|   1 |  SORT AGGREGATE                   |               |     1 |    45 |            |          |                                                                                                                                                                                                          
|   2 |   NESTED LOOPS                    |               |     4 |   180 |    52   (0)| 00:00:01 |                                                                                                                                                                                                          
|   3 |    NESTED LOOPS                   |               |     4 |   144 |    12   (0)| 00:00:01 |                                                                                                                                                                                                          
|   4 |     TABLE ACCESS BY INDEX ROWID   | PARTSUPPS     |     4 |    36 |     4   (0)| 00:00:01 |                                                                                                                                                                                                          
|*  5 |      INDEX RANGE SCAN             | PS_PARTKEY_IX |     4 |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                          
|*  6 |     TABLE ACCESS BY INDEX ROWID   | PARTS         |     1 |    27 |     2   (0)| 00:00:01 |                                                                                                                                                                                                          
|*  7 |      INDEX RANGE SCAN             | P_PARTKEY_IX  |     1 |       |     1   (0)| 00:00:01 |                                                                                                                                                                                                          
|   8 |    BITMAP CONVERSION COUNT        |               |     1 |     9 |    52   (0)| 00:00:01 |                                                                                                                                                                                                          
|   9 |     BITMAP AND                    |               |       |       |            |          |                                                                                                                                                                                                          
|  10 |      BITMAP CONVERSION FROM ROWIDS|               |       |       |            |          |                                                                                                                                                                                                          
|* 11 |       INDEX RANGE SCAN            | L_PARTKEY_IX  |    30 |       |     2   (0)| 00:00:01 |                                                                                                                                                                                                          
|  12 |      BITMAP CONVERSION FROM ROWIDS|               |       |       |            |          |                                                                                                                                                                                                          
|* 13 |       INDEX RANGE SCAN            | L_SUPPKEY_IX  |    30 |       |     2   (0)| 00:00:01 |                                                                                                                                                                                                          
---------------------------------------------------------------------------------------------------                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   5 - access("PS_PARTKEY"=5)                                                                                                                                                                                                                                                                                
   6 - filter(("P_TYPE"='MEDIUM ANODIZED BRASS' OR "P_TYPE"='MEDIUM BRUSHED COPPER') AND                                                                                                                                                                                                                     
              ("PS_PARTKEY"=5 AND "P_TYPE"='MEDIUM ANODIZED BRASS' OR "PS_PARTKEY"=5 AND                                                                                                                                                                                                                     
              "P_TYPE"='MEDIUM BRUSHED COPPER'))                                                                                                                                                                                                                                                             
   7 - access("P_PARTKEY"="PS_PARTKEY")                                                                                                                                                                                                                                                                      
  11 - access("PS_PARTKEY"="L_PARTKEY")                                                                                                                                                                                                                                                                      
  13 - access("PS_SUPPKEY"="L_SUPPKEY")                                                                                                                                                                                                                                                                      
\end{lstlisting}

\section{Deep Left Join?}

Beim Bushy Tree geht es darum, die Nodes gleichmässig zu verteilen. Eine gute Visualisierung, sowie ein Vergleich des Left Deep, Right Deep und Bushy Join ist unter \url{http://www.oaktable.net/content/right-deep-left-deep-and-bushy-joins} ersichtlich.

Wir haben versucht einen Bushy Tree zu bilden, indem wir ausschliesslich Hints verwenden (\emph{LEADING(...)}, \emph{USE\_HASH(...)}, \emph{NO\_MERGE}, ...). Dies ist jedoch nicht möglich.

Bei unseren Recherchen sind wir auf den Link \url{https://sites.google.com/site/embtdbo/Home/sql-hint-documentation} gestossen, in welchem beschrieben ist, dass ein Bushy Tree zwingend Subselects benötigt. Wir zitieren:
\begin{quote}
What Jonathan means by BUSHY is that Oracle does not execute the join of 2 or more tables and  then join that result to 2 other tables (or more) to achieve that affect you have that with Common Table Expressions (CTE) known as Subquery Factoring in Oracle (ie the 'with' clause) Oracle only joins one table table at a time to the current result set. In order to make Oracle join the results sets from table A and B to the result set from tables C and D, you have to use subqueries and the NO\_MERGE hint.
\end{quote}

Mithilfe den Subselects und den Hints \emph{NO\_MERGE} haben wir folgendes Query erstellt, welches einen Bushy Tree generiert:
\begin{lstlisting}
SELECT COUNT(*) FROM
  (SELECT /*+ no_merge */ ps_partkey, ps_suppkey
    FROM parts, partsupps
    WHERE p_partkey=ps_partkey)
   tbl_a,
  (SELECT /*+ no_merge */ l_partkey, l_suppkey
    FROM lineitems, orders
    WHERE l_orderkey=o_orderkey) 
  tbl_b
WHERE tbl_a.ps_partkey = tbl_b.l_partkey
AND tbl_a.ps_suppkey=tbl_b.l_suppkey;
\end{lstlisting}

Ohne Indices erhalten wir Kosten von 64246. Dabei wird für jede Tabelle ein \emph{TABLE ACCESS FULL} gemacht. Der Ausführungsplan wiederspiegelt die Struktur welche unter \url{http://www.oaktable.net/content/right-deep-left-deep-and-bushy-joins} beschrieben ist. Es werden jeweils zwei Tabellen mit einem \emph{HASH\_JOIN} verknüpft und in einer View gespeichert. Die beiden Views werden wiederum mit einem \emph{HASH\_JOIN} verknüpft, was schlussendlich zum Bushy Tree führt.
\begin{lstlisting}
-------------------------------------------------------------------------------------------                                                                                                                                                                                                                  
| Id  | Operation             | Name      | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                                                                                                                                  
-------------------------------------------------------------------------------------------                                                                                                                                                                                                                  
|   0 | SELECT STATEMENT      |           |     1 |    52 |       | 64246   (1)| 00:12:51 |                                                                                                                                                                                                                  
|   1 |  SORT AGGREGATE       |           |     1 |    52 |       |            |          |                                                                                                                                                                                                                  
|*  2 |   HASH JOIN           |           |   803K|    39M|    28M| 64246   (1)| 00:12:51 |                                                                                                                                                                                                                  
|   3 |    VIEW               |           |   792K|    19M|       |  6540   (1)| 00:01:19 |                                                                                                                                                                                                                  
|*  4 |     HASH JOIN         |           |   792K|    10M|  3328K|  6540   (1)| 00:01:19 |                                                                                                                                                                                                                  
|   5 |      TABLE ACCESS FULL| PARTS     |   200K|   976K|       |  1050   (1)| 00:00:13 |                                                                                                                                                                                                                  
|   6 |      TABLE ACCESS FULL| PARTSUPPS |   800K|  7031K|       |  4523   (1)| 00:00:55 |                                                                                                                                                                                                                  
|   7 |    VIEW               |           |  6086K|   150M|       | 45282   (1)| 00:09:04 |                                                                                                                                                                                                                  
|*  8 |     HASH JOIN         |           |  6086K|   121M|    25M| 45282   (1)| 00:09:04 |                                                                                                                                                                                                                  
|   9 |      TABLE ACCESS FULL| ORDERS    |  1500K|  8789K|       |  6599   (1)| 00:01:20 |                                                                                                                                                                                                                  
|  10 |      TABLE ACCESS FULL| LINEITEMS |  6001K|    85M|       | 29675   (1)| 00:05:57 |                                                                                                                                                                                                                  
-------------------------------------------------------------------------------------------                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   2 - access("TBL_A"."PS_PARTKEY"="TBL_B"."L_PARTKEY" AND                                                                                                                                                                                                                                                   
              "TBL_A"."PS_SUPPKEY"="TBL_B"."L_SUPPKEY")                                                                                                                                                                                                                                                      
   4 - access("P_PARTKEY"="PS_PARTKEY")                                                                                                                                                                                                                                                                      
   8 - access("L_ORDERKEY"="O_ORDERKEY")                                                                                                                                                                                                                                                                     
\end{lstlisting}

Bei Verwendung der Indices sinken die Kosten von 64246 auf 57686. Die Struktur des Ausführungsplans verändert sich nicht. Es wird lediglich ein \emph{INDEX FAST FULL SCAN} anstelle des einten \emph{TABLE ACCESS FULL} verwendet. 
\begin{lstlisting}
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
| Id  | Operation                | Name          | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                                                                                                                           
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
|   0 | SELECT STATEMENT         |               |     1 |    52 |       | 57686   (1)| 00:11:33 |                                                                                                                                                                                                           
|   1 |  SORT AGGREGATE          |               |     1 |    52 |       |            |          |                                                                                                                                                                                                           
|*  2 |   HASH JOIN              |               |   803K|    39M|    28M| 57686   (1)| 00:11:33 |                                                                                                                                                                                                           
|   3 |    VIEW                  |               |   792K|    19M|       |  5613   (1)| 00:01:08 |                                                                                                                                                                                                           
|*  4 |     HASH JOIN            |               |   792K|    10M|  3328K|  5613   (1)| 00:01:08 |                                                                                                                                                                                                           
|   5 |      INDEX FAST FULL SCAN| P_PARTKEY_IX  |   200K|   976K|       |   123   (1)| 00:00:02 |                                                                                                                                                                                                           
|   6 |      TABLE ACCESS FULL   | PARTSUPPS     |   800K|  7031K|       |  4523   (1)| 00:00:55 |                                                                                                                                                                                                           
|   7 |    VIEW                  |               |  6086K|   150M|       | 39649   (1)| 00:07:56 |                                                                                                                                                                                                           
|*  8 |     HASH JOIN            |               |  6086K|   121M|    25M| 39649   (1)| 00:07:56 |                                                                                                                                                                                                           
|   9 |      INDEX FAST FULL SCAN| O_ORDERKEY_IX |  1500K|  8789K|       |   965   (2)| 00:00:12 |                                                                                                                                                                                                           
|  10 |      TABLE ACCESS FULL   | LINEITEMS     |  6001K|    85M|       | 29675   (1)| 00:05:57 |                                                                                                                                                                                                           
--------------------------------------------------------------------------------------------------                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   2 - access("TBL_A"."PS_PARTKEY"="TBL_B"."L_PARTKEY" AND                                                                                                                                                                                                                                                   
              "TBL_A"."PS_SUPPKEY"="TBL_B"."L_SUPPKEY")                                                                                                                                                                                                                                                      
   4 - access("P_PARTKEY"="PS_PARTKEY")                                                                                                                                                                                                                                                                      
   8 - access("L_ORDERKEY"="O_ORDERKEY")                                                                                                                                                                                                                                                                     
\end{lstlisting}

\section{Eigene SQL-Anfragen}
Wir haben ein Query erstellt, welches die Bestellungen zurückgibt, die einen Preis von  502742.76 haben und die Priorität 1 besitzen.
\begin{lstlisting}
SELECT *
FROM orders
WHERE O_ORDERPRIORITY='1-URGENT'
AND O_TOTALPRICE = 502742.76;
\end{lstlisting}

Das Query kommt auf Kosten von 6610. Es werden weder Indices noch andere Optimierungen vorgenommen.
\begin{lstlisting}
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
|   0 | SELECT STATEMENT  |        |     1 |   111 |  6610   (1)| 00:01:20 |                                                                                                                                                                                                                                 
|*  1 |  TABLE ACCESS FULL| ORDERS |     1 |   111 |  6610   (1)| 00:01:20 |                                                                                                                                                                                                                                 
----------------------------------------------------------------------------                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_TOTALPRICE"=502742.76 AND "O_ORDERPRIORITY"='1-URGENT')                                                                                                                                                                                                                                     
\end{lstlisting}

Um die Kosten zu senken haben wir einen Index erstellt für den Gesamtpreis:
\begin{lstlisting}
CREATE INDEX o_totalprice_ix ON orders (O_TOTALPRICE) ;
\end{lstlisting}

Mit den Indices sinken die Kosten von 6610 auf 5. Die Kosten konnten also um einen Faktor von über 1000 gesenkt werden.
\begin{lstlisting}
-----------------------------------------------------------------------------------------------                                                                                                                                                                                                              
| Id  | Operation                   | Name            | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                              
-----------------------------------------------------------------------------------------------                                                                                                                                                                                                              
|   0 | SELECT STATEMENT            |                 |     1 |   111 |     5   (0)| 00:00:01 |                                                                                                                                                                                                              
|*  1 |  TABLE ACCESS BY INDEX ROWID| ORDERS          |     1 |   111 |     5   (0)| 00:00:01 |                                                                                                                                                                                                              
|*  2 |   INDEX RANGE SCAN          | O_TOTALPRICE_IX |     1 |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                              
-----------------------------------------------------------------------------------------------                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - filter("O_ORDERPRIORITY"='1-URGENT')                                                                                                                                                                                                                                                                  
   2 - access("O_TOTALPRICE"=502742.76)                                                                                                                                                                                                                                                                      
\end{lstlisting}

Für ein weiteres Beispiel haben wir ein Query gewählt, welches alle Bestellungen eines bestimmten Kundes zurückgibt.
\begin{lstlisting}
SELECT * FROM orders, customers
WHERE o_custkey = c_custkey
AND c_name = 'Customer#000124831';
\end{lstlisting}

Die Kosten für das Query betragen ohne Optimierung 7569.
\begin{lstlisting}
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
| Id  | Operation          | Name      | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                                             
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
|   0 | SELECT STATEMENT   |           |    15 |  4050 |  7569   (1)| 00:01:31 |                                                                                                                                                                                                                             
|*  1 |  HASH JOIN         |           |    15 |  4050 |  7569   (1)| 00:01:31 |                                                                                                                                                                                                                             
|*  2 |   TABLE ACCESS FULL| CUSTOMERS |     1 |   159 |   951   (1)| 00:00:12 |                                                                                                                                                                                                                             
|   3 |   TABLE ACCESS FULL| ORDERS    |  1500K|   158M|  6610   (1)| 00:01:20 |                                                                                                                                                                                                                             
--------------------------------------------------------------------------------                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   1 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
   2 - filter("C_NAME"='Customer#000124831')                                                                                                                                                                                                                                                                 
\end{lstlisting}

Für die Optimierung haben wir wiederum Indices erstellt, da dies eine der besten und einfachsten Optimierungsmöglichkeiten ist:
\begin{lstlisting}
CREATE INDEX o_custkey_ix ON orders(o_custkey) ;
CREATE INDEX c_name_ix ON customers(c_name) ;
\end{lstlisting}

Die Indices haben die Kosten von 7569 auf 21 gesenkt. Dies entspricht einem Faktor von ca. 360.
\begin{lstlisting}
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
| Id  | Operation                     | Name         | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                                                                                                               
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
|   0 | SELECT STATEMENT              |              |    15 |  4050 |    21   (0)| 00:00:01 |                                                                                                                                                                                                               
|   1 |  NESTED LOOPS                 |              |       |       |            |          |                                                                                                                                                                                                               
|   2 |   NESTED LOOPS                |              |    15 |  4050 |    21   (0)| 00:00:01 |                                                                                                                                                                                                               
|   3 |    TABLE ACCESS BY INDEX ROWID| CUSTOMERS    |     1 |   159 |     4   (0)| 00:00:01 |                                                                                                                                                                                                               
|*  4 |     INDEX RANGE SCAN          | C_NAME_IX    |     1 |       |     3   (0)| 00:00:01 |                                                                                                                                                                                                               
|*  5 |    INDEX RANGE SCAN           | O_CUSTKEY_IX |    15 |       |     2   (0)| 00:00:01 |                                                                                                                                                                                                               
|   6 |   TABLE ACCESS BY INDEX ROWID | ORDERS       |    15 |  1665 |    17   (0)| 00:00:01 |                                                                                                                                                                                                               
----------------------------------------------------------------------------------------------                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                             
Predicate Information (identified by operation id):                                                                                                                                                                                                                                                          
---------------------------------------------------                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
   4 - access("C_NAME"='Customer#000124831')                                                                                                                                                                                                                                                                 
   5 - access("O_CUSTKEY"="C_CUSTKEY")                                                                                                                                                                                                                                                                       
\end{lstlisting}

\section{Reflexion}
In erster Linie waren wir von den enormen Kostenunterschieden überrascht, die durch die Verwendung von Indices resp. den Verzicht darauf ausgelöst werden. Dass der Kostenunterschied und damit einhergehend die Ausführungszeit der Anfragen in derartigem Ausmass gesenkt werden kann, hätten wir uns nicht gedacht.

Interessant ist ebenfalls, dass der Optimizer keinesfalls immer Zugriffe über Indices verwendet sobald diese vorhanden wären. Bei Queries ohne Selektion oder mit grossen Intervallen bei Range-Searches verwendet Oracle trotz vorhandenen Indices volle Tabellenzugriffe (vgl. Abschnitt \ref{idx-sel-range} auf Seite \pageref{idx-sel-range}), da dadurch grössere Blöcke am Stück von der Disk gelesen werden können und die hohen Kosten für IO einigermassen in Zaum gehalten werden. Eine Ausnahme diesbezüglich stellt das Query im Abschnitt \ref{idx-pro-singlecol-distinct} auf Seite \pageref{idx-pro-singlecol-distinct} dar, da in diesem fall die angefragten Daten komplett im Index gespeichert sind.

Indices belegen zwar zusätzlichen Speicherplatz, aber bei den heutigen Preisen für Arbeitsspeicher und Festplatten überwiegen die Geschwindigkeitsvorteile gegenüber dem Verzicht auf Indices klar. Da die Festplatten (und auch die darauf gespeicherten Datenbanken) immer grösser werden, aber die Geschwindigkeit nicht im selben Ausmass zunimmt wie die Speicherdichte (von Solid-State-Drives einmal abgesehen), wird sich dieser Effekt in Zukunft noch verstärken.

Indices müssten gemäss unserem Verständnis beim Einfügen und Aktualisieren von Datensätzen gewisse Kosten verursachen. Wir haben versucht dies mittels erneutem Befüllen der Orders-Tabelle (einmal mit und einmal ohne Indices) nachzuvollziehen, allerdings zeigen die Ausführungspläne dabei auch bzgl. Kosten keine Unterschiede.
\end{document}